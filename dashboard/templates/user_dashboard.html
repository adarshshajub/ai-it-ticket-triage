{% extends 'base.html' %}
{% load static %}

{% block title %}My Dashboard{% endblock %}

{% if messages %}
  {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
      {{ message }}
      <button class="btn-close" data-bs-dismiss="alert"></button>
    </div>
  {% endfor %}
{% endif %}

{% block content %}
<!-- <div class="container-xxl mt-4"> -->
  <div class="row mb-3">
    <div class="col-12 d-flex align-items-center justify-content-between">
      <div>
        <h4 class="mb-0">My Dashboard</h4>
        <small class="text-muted">Hello, {{ request.user.get_full_name|default:request.user.username }}</small>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'tickets:create_ticket' %}" class="btn btn-primary btn-sm">Create Issue</a>
        <a href="{% url 'tickets:ticket_list' %}" class="btn btn-outline-secondary btn-sm">My Tickets</a>
      </div>
    </div>
  </div>

  <!-- summary cards -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card card-compact p-3 h-100">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <div class="stat-label">Total Issues Reported</div>
            <div class="stat-value text-info">{{ total_by_user|default:"0" }}</div>
          </div>
        </div>
        <small class="text-muted mt-2 d-block">Since you joined</small>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card card-compact p-3 h-100">
        <div>
          <div class="stat-label">Open Issues</div>
          <div class="stat-value text-warning">{{ open_by_user|default:"0" }}</div>
          <small class="text-muted">Needs attention</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card card-compact p-3 h-100">
        <div>
          <div class="stat-label">Resolved Issues</div>
          <div class="stat-value text-success">{{ resolved_tickets|default:"0" }}</div>
          <small class="text-muted">All set</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-md-3">
      <div class="card card-compact p-3 h-100">
        <div>
          <div class="stat-label">Recent Issues</div>
          <div class="stat-value text-warning">{{ recent_tickets|default:"0" }}</div>
          <small class="text-muted">Needs attention</small>
        </div>
      </div>
    </div>
    
  </div>

  <!-- My tickets table -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card card-compact p-3">
        <div class="d-flex align-items-center mb-3 ">
          <h6 class="mb-0">My Tickets</h6>
          <div class="d-flex gap-2 align-items-center" style="margin-left:auto; padding-right: 0rem;">
            <a class="btn btn-sm btn-primary" href="{% url 'tickets:ticket_list' %}" class="btn btn-link btn-sm">Expand</a>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead>
              <tr>
                <th style="min-width: 20px">ID</th>
                <th style="min-width: 200px">Title</th>
                <th>Status</th>
                <th>Assigned Team</th>
                <th>ServiceNow</th>
                <th>Created</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for ticket in tickets %}
              <tr id="ticket-row-{{ ticket.id }}">
                <td>{{ ticket.id }}</td>
                <td style="max-width:250px;">{{ ticket.title|truncatechars:50 }}</td>
                <td>{{ ticket.servicenow_ticket_status }}</td>
                <td>{{ ticket.get_category_display }}</td>
                <td>{{ ticket.servicenow_ticket_number|default:"â€”" }}</td>
                <td>{{ ticket.created_at|date:"Y-m-d H:i" }}</td>
                 <td class="text-info">
                    <a href="{% url 'tickets:ticket_detail' ticket.id %}" class="btn btn-sm btn-outline-secondary">View</a>
                  </td>  
              </tr>
              {% empty %}
              <tr><td colspan="7">No tickets found.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="mt-3 d-flex justify-content-end">
          {% if is_paginated %}
            <nav>
              <ul class="pagination pagination-sm mb-0">
                {% if page_obj.has_previous %}
                  <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">Prev</a></li>
                {% endif %}
                <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span></li>
                {% if page_obj.has_next %}
                  <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a></li>
                {% endif %}
              </ul>
            </nav>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

{% endblock %}
